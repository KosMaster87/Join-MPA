name: Build PWA & Deploy to IONOS

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”¨ Generate Service Worker with Workbox
        run: npm run build-sw

      - name: ğŸ“ Show Generated Service Worker Info
        run: |
          echo "âœ… Service Worker generated successfully!"
          ls -lh service-worker.js
          head -30 service-worker.js

      - name: ğŸ“ Prepare Deployment Structure
        run: |
          mkdir -p deploy

          # Copy all source files (index.html, pages, css, js, etc.)
          cp -r index.html deploy/ 2>/dev/null || true
          cp -r pages deploy/ 2>/dev/null || true
          cp -r css deploy/ 2>/dev/null || true
          cp -r js deploy/ 2>/dev/null || true
          cp -r assets deploy/ 2>/dev/null || true
          cp -r config deploy/ 2>/dev/null || true
          cp -r services deploy/ 2>/dev/null || true

          # Copy generated Service Worker
          cp service-worker.js deploy/

          # Copy .htaccess with proper PWA headers
          cat > deploy/.htaccess << 'EOF'
          # ======================================================
          # ğŸš« Block direct access to /pages/ in the URL
          # ======================================================
          RewriteCond %{THE_REQUEST} \s/+pages/ [NC]
          RewriteRule ^pages/ - [F]

          # ======================================================
          # ğŸ” Apache Configuration for Join MPA
          # ======================================================
          RewriteEngine On
          RewriteBase /

          # ======================================================
          # ğŸ”’ Force HTTPS
          # ======================================================
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # ======================================================
          # ğŸ›¡ï¸ API Routes Protection - Don't rewrite API calls
          # ======================================================
          RewriteCond %{REQUEST_URI} ^/api/
          RewriteRule . - [L]

          # ======================================================
          # ğŸŒ Pretty URLs: /summary.html -> /pages/summary.html
          # ======================================================
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^([a-zA-Z0-9_-]+)\.html$ /pages/$1.html [L]

          # ======================================================
          # ğŸ“± Service Worker & Manifest - NO CACHE (Critical!)
          # ======================================================
          <IfModule mod_headers.c>
            # Service Worker MUST always be fresh
            <FilesMatch "^service-worker\.js$">
              Header set Cache-Control "no-cache, no-store, must-revalidate"
              Header set Pragma "no-cache"
              Header set Expires "0"
              Header set Content-Type "application/javascript"
              Header set Service-Worker-Allowed "/"
            </FilesMatch>

            # Manifest files - short cache only
            <FilesMatch "\.webmanifest$">
              Header set Cache-Control "public, max-age=3600"
              Header set Content-Type "application/manifest+json"
            </FilesMatch>
          </IfModule>

          # ======================================================
          # ğŸš€ Cache Control fÃ¼r Static Assets
          # ======================================================
          <IfModule mod_expires.c>
            ExpiresActive on

            # CSS - Long cache (will be updated with new SW)
            ExpiresByType text/css "access plus 1 year"

            # JavaScript - Long cache (will be updated with new SW)
            ExpiresByType application/javascript "access plus 1 year"

            # Images - Long cache
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType image/avif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"

            # Fonts - Very long cache
            ExpiresByType font/woff2 "access plus 1 year"

            # JSON - Don't cache
            ExpiresByType application/json "access plus 0 seconds"
          </IfModule>

          # ======================================================
          # ğŸ” Security Headers
          # ======================================================
          <IfModule mod_headers.c>
            # Prevent MIME type sniffing
            Header always set X-Content-Type-Options nosniff

            # Prevent clickjacking
            Header always set X-Frame-Options DENY

            # XSS Protection
            Header always set X-XSS-Protection "1; mode=block"

            # HSTS - Force HTTPS for 1 year
            Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

            # Remove Server signature
            Header unset Server
          </IfModule>
          EOF

      - name: ğŸ“¤ Deploy to IONOS via SFTP
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
        uses: Dylan700/sftp-upload-action@v1.1.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 22
          uploads: |
            ./deploy/ => ./join-mpa/
          delete: false

      - name: âœ… Deployment Complete
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
        run: |
          echo "ğŸ‰ PWA Deployment successful!"
          echo "ğŸ“± App: https://join-mpa.dev2k.org"
          echo "ğŸ”„ Service Worker: Automatically updated with hash-based versioning"
          echo "ğŸ’¾ Cache: Intelligently managed by Workbox"

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… PWA Build Successful\n\n- ğŸ”¨ Service Worker: Generated with Workbox\n- ğŸ“± Manifest: Ready\n- ğŸ”„ Cache Busting: Automatic hash-based versioning\n- ğŸ’¾ Assets: Optimized caching strategies\n\nReady to merge! ğŸš€`
            })
